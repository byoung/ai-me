services:
  # Production runtime stage - minimal image with only production dependencies
  runtime:
    build:
      context: .
      target: runtime
    volumes:
      - ./:/app
      - /app/.venv  # Anonymous volume for container's venv
    ports:
      - 7860:7860
    working_dir: /app
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN:-}
    command: ["src/app.py"]

  # Notebooks stage - uses runtime with development tools
  notebooks:
    build:
      context: .
      target: test  # Uses test stage which has dev dependencies
    volumes:
      - ./:/app
      - /app/.venv  # Anonymous volume for container's venv
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 7861:7861
    working_dir: /app
    user: "0:0"

  # Test stage - extends runtime with dev dependencies and Playwright
  test:
    build:
      context: .
      target: test  # Explicitly build the test stage
    volumes:
      - ./:/app
      - /app/.venv  # Anonymous volume for container's venv
      - ./htmlcov:/app/htmlcov  # Mount htmlcov for coverage reports
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /app
    user: "0:0"
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN:-}
      - PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=false
    entrypoint: []
    command: ["uv", "run", "pytest", "tests/unit", "tests/integration", "-v", "--cov=src", "--cov-report=html", "--cov-report=term-missing"]
