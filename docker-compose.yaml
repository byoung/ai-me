services:
  browser:
    image: mcr.microsoft.com/playwright:v1.55.0-noble

  notebooks:
    build: .
    # Mount source code but exclude .venv to avoid host/container conflicts
    volumes:
      - ./:/app
      - /app/.venv  # Anonymous volume for container's venv
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 7861:7861
    working_dir: /app
    user: "0:0"

  test:
    build: .
    # Mount source code but exclude .venv to avoid host/container conflicts
    volumes:
      - ./:/app
      - /app/.venv  # Anonymous volume for container's venv
      - ./htmlcov:/app/htmlcov  # Mount htmlcov for coverage reports
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /app
    user: "0:0"
    environment:
      - GROQ_API_KEY=${GROQ_API_KEY}
      - GITHUB_PERSONAL_ACCESS_TOKEN=${GITHUB_PERSONAL_ACCESS_TOKEN:-}
      - PLAYWRIGHT_SKIP_BROWSER_DOWNLOAD=false
    entrypoint: []
    command: ["uv", "run", "pytest", "tests/unit", "tests/integration", "-v", "--cov=src", "--cov-report=html", "--cov-report=term-missing"]
